
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
        <script src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.3/require.min.js"></script>
        <link href="/assets/charts/v0.3.2/condensed-font.css" rel="stylesheet">
        <link href="README.md" rel="doc">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                overflow: hidden;
                background-color: #fff;
            }
        </style>
    </head>
    <body>
        <script>
            var config = {"baseUrl":"/assets","paths":{"http":"js-data-libs/v0.8.0/http","text":"//cdnjs.cloudflare.com/ajax/libs/require-text/2.0.12/text.min","gist-db":"js-data-libs/v0.8.0/gist-db","mlab-db":"js-data-libs/v0.8.0/mlab-db","on-demand":"js-data-libs/v0.8.0/on-demand","crypto":"js-data-libs/v0.8.0/crypto","sjcl":"//cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.6/sjcl.min","chart":"charts/v0.3.2/diagram/chart","snap.svg":"//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min","twopassresize":"charts/v0.3.2/twopassresize","tabletop":"//cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.2/tabletop.min","ext_parser":"charts/v0.3.2/diagram/ext_parser"},"shim":{"sjcl":{"exports":"sjcl"},"ext_parser":{"exports":"parser"}}};
            config.config = {text: {useXhr: function(url, protocol, hostname, port) {
                return true; // force use of CORS for text dependencies
            }}};
            require.config(config);

            var params = (function(uri) {
                    var a = document.createElement('a');
                    a.href = uri;
                    return a.search.replace(/^\?/, '').split('&').reduce(function(obj, pair) {
                        var tokens = pair.split('=');
                        obj[tokens[0]] = decodeURIComponent(tokens[1]);
                        return obj;
                    }, {});
                })(window.location.href);
            var layout = params.layout;
            var data = params.data;

            require(['chart'], function(Chart) {
                var chart,
                    parse = function(str, cb) {

                        require(['ext_parser'], function(parser) {
                            try {
                                cb(parser.parse(str.replace(/\n|\r/g, '')));
                            } catch(e) {
                                console.log('Parser error: '+e.message);
                            }
                        });

                    },
                    update = function(data) {
                        chart.update(data);
                    },
                    params = {margin: 0.05};


                chart = Chart(document.body, params);

                window.addEventListener('resize', chart.resize);


var match,
    str;

if (match = data.match(/^data:([^,;]+)(;[^,]+)?,(.*)/)) {
    str = decodeURIComponent(match[3]);
    if (match[1] == 'text/csv') {
        str = str.replace(/;/g, '\n');
    }
    parse(str, update);
} else if (data.match(/^https?:/)) {
    require(['http', 'on-demand', 'crypto'], function(Http, OnDemand, crypto) {
        var uri = data,
            cipherKey = OnDemand(sessionStorage, 'cipherKey');

        Http.get(uri, function(data) {
            parse(crypto.decipher(cipherKey(), data), update);
        }, true);
    });
} else if (match = data.match(/mg\/(.+)/)) {
    require(['mlab-db', 'on-demand', 'crypto'], function(MlabDb, OnDemand, crypto) {
        var id = match[1],
            apiKey = OnDemand(localStorage, 'mlabApiKey'),
            db = MlabDb({apikey: apiKey(), database: 'misc', collection: 'webviews'}),
            cipherKey = OnDemand(sessionStorage, 'cipherKey');

        db.get({query: {id: id}, unique: true}, function(data) {
            parse(crypto.decipher(cipherKey(), JSON.stringify(data.value)), update);
        });
    });
} else if (match = data.match(/db\/(.+)/)) {
    require(['gist-db', 'on-demand', 'crypto'], function(GistDb, OnDemand, crypto) {
        var id = match[1],
            githubPwd = OnDemand(sessionStorage, 'githubPwd'),
            dbGistId = OnDemand(localStorage, 'dbGistId'),
            db = GistDb({gistid: dbGistId(), user: 'ehouais', password: githubPwd()}),
            cipherKey = OnDemand(sessionStorage, 'cipherKey');

        db.get(id, function(data) {
            parse(crypto.decipher(cipherKey(), data.content), update);
        });
    });
} else if (match = data.match(/gs\/(.+)/)) {
    require(['tabletop'], function(Tabletop) {
        Tabletop.init({
            key: 'https://docs.google.com/spreadsheets/d/'+match[1]+'/pubhtml',
            callback: function(data, tabletop) {
                var sheet = tabletop.models[tabletop.modelNames[0]]; // first sheet
                update({
                    cols: sheet.columnNames.map(function(name) {
                        return {label: name};
                    }),
                    rows: sheet.toArray()
                });
            },
            simpleSheet: true
        });
    });
} else {
    parse(data, update);
}

            });
        </script>
    </body>
</html>
